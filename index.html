<script>
const { createApp, ref, onMounted, onUnmounted } = Vue;
const { showToast, showDialog, showLoadingToast, closeToast } = vant;

// ملاحظة: ضع رابط الـ Worker الخاص بك هنا
const SERVER = "https://YOUR_WORKER.workers.dev";
const isTG = !!window.Telegram?.WebApp;
const tg = window.Telegram?.WebApp;

createApp({
  setup() {
    const user = ref({ balance: 0, vip: 0, referrals: 0 });
    const loading = ref(false); // لمنع تكرار الضغط
    const net = ref("TRC20");
    const tx = ref("");
    const wAmt = ref("");
    const wAddr = ref("");

    const depositTRC = "TEsCEHSkKwWTLLdEuGCHnpf23e8Sv3cZto";
    const depositBEP = "0x88bea8db94f9428f282b2cc375ec68ac67fd9200";

    const tickerItems = ref([]);
    let tickerTimer = null;

    // --- دالة التواصل مع الخادم (محسنة) ---
    const api = async (action, payload = {}) => {
      if (!isTG) {
        showToast("يرجى فتح التطبيق من داخل تيليجرام");
        return null;
      }

      loading.value = true;
      const toast = showLoadingToast({ message: 'جاري التحميل...', forbidClick: true });

      try {
        const res = await fetch(SERVER, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            initData: tg.initData,
            action,
            payload,
          }),
        });

        const d = await res.json();
        closeToast();

        if (!d.ok) {
          showToast(d.error || "حدث خطأ غير متوقع");
          return d;
        }

        if (d.user) user.value = d.user; // تحديث بيانات المستخدم تلقائياً
        
        // تفعيل اهتزاز بسيط عند النجاح
        if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
        
        return d;
      } catch (e) {
        closeToast();
        showToast("خطأ في الاتصال بالخادم");
        return null;
      } finally {
        loading.value = false;
      }
    };

    const maskUser = (uid) => {
      const s = String(uid);
      return "User***" + s.slice(-4);
    };

    const loadTicker = async () => {
      try {
        const res = await fetch(SERVER, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            initData: tg.initData,
            action: "get_withdrawals",
          }),
        });
        const d = await res.json();
        if (d.ok && Array.isArray(d.items)) {
          tickerItems.value = d.items.map(i => ({
            text: `⭐ VIP ${i.vipLevel} • ${maskUser(i.userId)} سحب ${i.amount}$ ✅`
          }));
        }
      } catch (e) { console.error("Ticker fetch error", e); }
    };

    // دالة التعدين (Mining) مع منع السبام
    const handleMine = async () => {
      if (loading.value) return;
      const res = await api("mine");
      if (res?.ok) showToast("تم التعدين بنجاح! ⛏️");
    };

    // دالة الإيداع
    const handleDeposit = async () => {
      if (!tx.value) return showToast("أدخل هاش العملية أولاً");
      const res = await api("deposit", { txid: tx.value, network: net.value });
      if (res?.ok) {
        showDialog({ title: 'تم الطلب', message: 'جاري مراجعة عملية الإيداع من قبل الإدارة.' });
        tx.value = "";
      }
    };

    // دالة السحب
    const handleWithdraw = async () => {
      const amount = parseFloat(wAmt.value);
      if (!wAddr.value || isNaN(amount) || amount <= 0) return showToast("بيانات السحب غير صحيحة");
      
      const res = await api("withdraw", { amount: amount, wallet: wAddr.value });
      if (res?.ok) {
        showDialog({ title: 'تم طلب السحب', message: 'سيتم تحويل المبلغ لمحفظتك بعد المراجعة.' });
        wAmt.value = "";
        wAddr.value = "";
      }
    };

    onMounted(async () => {
      if (isTG) {
        tg.expand(); // توسيع الواجهة لتملأ الشاشة
        tg.ready();

        // معالجة رابط الإحالة
        const startParam = tg.initDataUnsafe?.start_param;
        await api("login", {
          ref: startParam ? startParam : null,
        });

        await loadTicker();
        tickerTimer = setInterval(loadTicker, 20000); // تحديث كل 20 ثانية لتوفير الطلبات
      } else {
        showDialog({ title: "تنبيه", message: "يجب تشغيل هذا التطبيق داخل Telegram" });
      }
    });

    onUnmounted(() => {
      if (tickerTimer) clearInterval(tickerTimer);
    });

    return {
      user, net, tx, wAmt, wAddr,
      depositTRC, depositBEP, tickerItems, loading,
      handleMine, handleDeposit, handleWithdraw
    };
  },
}).use(vant).mount("#app");
</script>

<style>
/* تحسين شكل شريط السحوبات */
.withdraw-ticker {
  position: fixed;
  bottom: 80px;
  width: 100%;
  background: rgba(15, 15, 15, 0.95);
  border-top: 1px solid #ffd70033;
  overflow: hidden;
  height: 40px;
  z-index: 99;
  display: flex;
  align-items: center;
}

.withdraw-track {
  display: flex;
  gap: 50px;
  white-space: nowrap;
  animation: scrollLeft 30s linear infinite;
}

.withdraw-item {
  color: #FFD700;
  font-size: 13px;
  font-weight: bold;
  text-shadow: 0 0 5px rgba(255, 215, 0, 0.3);
}

@keyframes scrollLeft {
  0% { transform: translateX(100vw); }
  100% { transform: translateX(-100%); }
}

/* تنسيقات إضافية للأزرار أثناء التحميل */
.btn-loading {
  opacity: 0.6;
  pointer-events: none;
}
</style>

<div class="withdraw-ticker" v-if="tickerItems.length">
  <div class="withdraw-track">
    <div class="withdraw-item" v-for="(t,i) in tickerItems" :key="i">
      {{ t.text }}
    </div>
    <div class="withdraw-item" v-for="(t,i) in tickerItems" :key="'copy-'+i">
      {{ t.text }}
    </div>
  </div>
</div>
