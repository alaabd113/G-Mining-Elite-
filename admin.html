<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TokenDrip Ops Center</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        :root { --bg-color: #0f0f0f; --card-bg: #1e1e1e; --primary: #00E676; --danger: #FF5252; --warning: #FFC107; --text-color: #ffffff; --border: #333; }
        body { background-color: var(--bg-color); color: var(--text-color); font-family: 'Cairo', sans-serif; margin: 0; padding: 20px; padding-bottom: 80px; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 15px; }
        .header h1 { margin: 0; font-size: 1.4rem; color: var(--primary); }
        .refresh-btn { background: #333; border: 1px solid #444; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s; }
        .refresh-btn:active { transform: rotate(180deg); }

        .card { background: var(--card-bg); border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid var(--border); box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        h3 { margin-top: 0; color: #fff; font-size: 1.1rem; border-bottom: 1px solid #333; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        
        label { display: block; margin-bottom: 5px; color: #aaa; font-size: 0.85rem; margin-top: 15px;}
        input, select { width: 100%; padding: 12px; background: #252525; border: 1px solid #444; border-radius: 8px; color: white; font-family: inherit; font-size: 1rem; box-sizing: border-box; transition: 0.3s; }
        input:focus { border-color: var(--primary); outline: none; }
        
        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-family: inherit; font-size: 1rem; transition: 0.2s; }
        button:disabled { opacity: 0.3; cursor: not-allowed; filter: grayscale(100%); }
        
        .btn-search { background: #FF9800; color: black; width: 100%; margin-top: 10px; }
        .btn-approve { background: var(--primary); color: #000; }
        .btn-reject { background: rgba(255, 82, 82, 0.1); color: var(--danger); border: 1px solid var(--danger); }
        .btn-ban { background: #660000; color: white; border: 1px solid #ff0000; }
        .btn-unban { background: #333; color: white; border: 1px solid #555; }
        .btn-blue { background: #2196F3; color: white; width: 100%; }

        .status-badge { padding: 4px 10px; border-radius: 6px; font-size: 0.85rem; font-weight: bold; display: inline-block; margin-bottom: 10px;}
        .status-active { background: rgba(0, 230, 118, 0.1); color: var(--primary); border: 1px solid var(--primary); }
        .status-banned { background: rgba(255, 82, 82, 0.1); color: var(--danger); border: 1px solid var(--danger); }
        .status-review { background: rgba(255, 193, 7, 0.1); color: var(--warning); border: 1px solid var(--warning); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        .macros-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px; }
        .macro-btn { padding: 8px; font-size: 0.8rem; background: #333; color: #ccc; border: 1px solid #444; border-radius: 6px; text-align: center; }
        .macro-btn:hover { background: #444; color: white; }

        #loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #333; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #toast { visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333; color: #fff; text-align: center; border-radius: 50px; padding: 16px; position: fixed; z-index: 10000; left: 50%; bottom: 30px; font-size: 0.9rem; box-shadow: 0 4px 15px rgba(0,0,0,0.5); opacity: 0; transition: 0.3s; }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }
        
        .log-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #333; font-size: 0.85rem; }
    </style>
</head>
<body>
    <div id="loader-overlay"><div class="spinner"></div><p style="margin-top: 15px; color:#888">Connecting...</p></div>
    <div id="toast">Notification</div>

    <div class="header">
        <div>
            <h1>ğŸ›¡ï¸ TokenDrip Ops</h1>
            <span style="font-size:0.75rem; color:#666;">v3.2 Golden Reference</span>
        </div>
        <div class="refresh-btn" onclick="refreshAll()" title="Refresh All"><i class="ri-refresh-line"></i></div>
    </div>
    
    <div id="loginSection" style="display:none; text-align:center; padding:50px 0;">
        <h2 style="color:var(--danger); margin-bottom:20px">ğŸ”’ Access Restricted</h2>
        <input type="password" id="adminPass" placeholder="Enter Security Code" style="text-align:center; font-size:1.2rem; margin-bottom:15px; width: 80%;">
        <button class="btn-blue" style="width: 80%;" onclick="checkPass()">Authenticate</button>
    </div>

    <div id="adminContent" style="display:none;">
        
        <div class="card" style="border:1px dashed #444; background:rgba(255,255,255,0.02); display:flex; justify-content:space-between; align-items:center;">
            <div>
                <h4 style="margin:0 0 5px; color:#aaa;">Global Stats</h4>
                <div style="font-size:0.8rem; color:#666;">Check Pending & Liquidity</div>
            </div>
            <button onclick="window.open('https://t.me/TokenDrip_bot')" style="width:auto; padding:8px 15px; background:#333; font-size:0.8rem;">Use /stats ğŸ¤–</button>
        </div>

        <div class="card">
            <h3>ğŸ” ØªØ¯Ù‚ÙŠÙ‚ Ù…Ø³ØªØ®Ø¯Ù… (Audit)</h3>
            <input type="number" id="searchId" class="user-id-input" placeholder="User ID / Telegram ID">
            <button class="btn-search" onclick="fetchUserInfo()">Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            
            <div id="searchResult" style="display:none; margin-top:15px; border-top:1px dashed #444; padding-top:15px;">
                </div>
        </div>

        <div class="card">
            <h3>âš¡ Ù…Ø¹Ø§Ù„Ø¬Ø© (Process TX)</h3>
            <div style="background:rgba(255,193,7,0.05); padding:10px; border-radius:8px; margin-bottom:15px; font-size:0.8rem; color:#aaa; border:1px solid #333;">
                â„¹ï¸ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© ØªØ¹ÙŠØ¯ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¥Ù„Ù‰ <b>Active</b> ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.<br>
                â„¹ï¸ Ø§Ù„Ø±ÙØ¶ ÙŠØ¹ÙŠØ¯ Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ù„Ø±ØµÙŠØ¯.<br>
            </div>
            
            <label>User ID</label>
            <input type="number" id="targetId" class="user-id-input" placeholder="User ID">
            
            <label>TX Reference (Ref)</label>
            <div style="display:flex; gap:5px;">
                <input type="text" id="txRef" placeholder="e.g. wd_170...">
                <button style="width:50px; background:#333;" onclick="pasteToTxRef()">ğŸ“‹</button>
            </div>

            <div class="btn-group">
                <button class="btn-approve" onclick="updateStatus('approved')">âœ… Ù…ÙˆØ§ÙÙ‚Ø© (Approve)</button>
                <button class="btn-reject" onclick="updateStatus('rejected')">âŒ Ø±ÙØ¶ (Reject)</button>
            </div>
        </div>

        <div class="card">
            <h3>ğŸ’¬ Ø±Ø¯ÙˆØ¯ Ø¬Ø§Ù‡Ø²Ø© (Macros)</h3>
            <input type="text" id="macroInput" placeholder="Ø§Ø¶ØºØ· Ù„Ù†Ø³Ø® Ø§Ù„Ø±Ø¯..." readonly style="background:#111; color:var(--primary); font-size:0.9rem;">
            <div class="macros-grid">
                <button class="macro-btn" onclick="copyMacro('Ø·Ù„Ø¨Ùƒ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±.')">â³ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</button>
                <button class="macro-btn" onclick="copyMacro('ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ âœ…')">âœ… ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„</button>
                <button class="macro-btn" onclick="copyMacro('Ù…Ø±ÙÙˆØ¶: ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø©.')">âŒ Ù…Ø­ÙØ¸Ø© Ø®Ø§Ø·Ø¦Ø©</button>
                <button class="macro-btn" onclick="copyMacro('Ù…Ø±ÙÙˆØ¶: TXID ØºÙŠØ± ØµØ­ÙŠØ­.')">âŒ Ø®Ø·Ø£ TXID</button>
            </div>
        </div>

        <div class="card">
            <h3>ğŸ› ï¸ ØªØ¹Ø¯ÙŠÙ„ ÙŠØ¯ÙˆÙŠ (Admin Edit)</h3>
            <label>Target ID</label>
            <input type="number" id="manualId" class="user-id-input" placeholder="User ID">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                <input type="number" id="manualBalance" placeholder="Bal (+/-)">
                <select id="manualVip">
                    <option value="">VIP Level</option>
                    <option value="0">Free</option>
                    <option value="1">VIP 1</option>
                    <option value="2">VIP 2</option>
                    <option value="3">VIP 3</option>
                    <option value="4">VIP 4</option>
                    <option value="5">VIP 5</option>
                    <option value="6">VIP 6</option> </select>
            </div>
            <button class="btn-blue" style="margin-top:15px;" onclick="manualUpdate()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
        </div>
    </div>

    <script>
        // âš ï¸ Ù‡Ø§Ù…: ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø·Ø§Ø¨Ù‚ Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯
        const SERVER = "https://steep-resonance-6443.alaabdalaziz01.workers.dev";
        const ALLOWED_ADMIN_ID = 921301895;
        const ADMIN_PASS = "Admin@Token2024"; 

        const tg = window.Telegram.WebApp;
        tg.expand();

        window.onload = function() {
            const userId = tg.initDataUnsafe?.user?.id;
            if (userId === ALLOWED_ADMIN_ID) showAdminPanel();
            else document.getElementById('loginSection').style.display = 'block';
            const lastId = localStorage.getItem('lastAdminUserId'); 
            if(lastId) document.querySelectorAll('.user-id-input').forEach(input => input.value = lastId); 
        };

        function checkPass() { if (document.getElementById('adminPass').value === ADMIN_PASS) showAdminPanel(); else alert("Access Denied"); }
        function showAdminPanel() { document.getElementById('loginSection').style.display = 'none'; document.getElementById('adminContent').style.display = 'block'; }
        
        function saveUserId(id) { if(id) { localStorage.setItem('lastAdminUserId', id); document.querySelectorAll('.user-id-input').forEach(input => input.value = id); } }
        function setBusy(isBusy) { document.getElementById('loader-overlay').style.display = isBusy ? 'flex' : 'none'; }
        function toast(msg, type = 'success') { const t = document.getElementById("toast"); t.innerText = msg; t.style.background = type === 'error' ? '#FF5252' : '#00E676'; t.className = "show"; setTimeout(() => { t.className = ""; }, 3000); }
        
        function refreshAll() {
            const id = document.getElementById('searchId').value;
            if(id) fetchUserInfo();
            else location.reload();
        }

        async function pasteToTxRef() { try { const t = await navigator.clipboard.readText(); document.getElementById('txRef').value = t; toast("Paste OK"); } catch (e) { toast("Clipboard Error", "error"); } }
        function copyMacro(txt) { navigator.clipboard.writeText(txt); document.getElementById('macroInput').value = txt; toast("Copied"); }

        async function api(act, pl) {
            setBusy(true);
            try {
                const r = await fetch(SERVER, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ initData: tg.initData, action: act, payload: pl }) });
                setBusy(false);
                return await r.json();
            } catch (e) { setBusy(false); toast("Network Error", "error"); return { ok: false }; }
        }

        async function fetchUserInfo() {
            const id = document.getElementById('searchId').value;
            if(!id) return toast("Enter ID", "error");
            saveUserId(id);
            const d = await api("admin_get_user", { targetUserId: id });
            const box = document.getElementById('searchResult');
            
            if(d.ok && d.user) {
                const u = d.user;
                let badgeClass = 'status-active';
                let badgeText = 'ACTIVE âœ…';
                let banDisabled = false;
                let unbanDisabled = true;

                if(u.isBanned || u.status === 'banned') { 
                    badgeClass = 'status-banned'; badgeText = 'BANNED ğŸš«'; 
                    banDisabled = true; unbanDisabled = false;
                }
                else if(u.status === 'review') { badgeClass = 'status-review'; badgeText = 'UNDER REVIEW âš ï¸'; }

                // Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø¹Ø§Ù…
                let logsHtml = '';
                if(u.logs && u.logs.length > 0) {
                    u.logs.slice(0,5).forEach(l => {
                        logsHtml += `<div class="log-row"><span>${l.type}</span><span style="color:${l.amount>0?'#00E676':'#FF5252'}">${l.amount}$</span></div>`;
                    });
                } else { logsHtml = '<div style="color:#666; text-align:center;">No recent activity</div>'; }

                // âœ… Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª (Ø¬Ø¯ÙŠØ¯)
                let refHtml = '';
                if(u.refLogs && u.refLogs.length > 0) {
                    u.refLogs.slice(0,3).forEach(r => {
                        refHtml += `<div class="log-row"><span style="color:#aaa">ğŸ‘¥ ${r.user}</span><span style="color:#00E676">${r.plan}</span></div>`;
                    });
                }

                box.style.display = "block";
                box.innerHTML = `
                    <div style="text-align:center; margin-bottom:15px;">
                        <span class="status-badge ${badgeClass}">${badgeText}</span>
                    </div>
                    <div style="font-size:0.9rem; line-height:1.8;">
                        ğŸ‘¤ <b>User:</b> ${u.username || 'N/A'} (<code>${u.id}</code>)<br>
                        ğŸ’° <b>Balance:</b> <span style="color:var(--primary); font-size:1.1rem; font-weight:bold;">${u.balance}$</span><br>
                        ğŸ† <b>VIP:</b> Level ${u.vip}<br>
                        ğŸ‘¥ <b>Refs:</b> ${u.referrals} ${refHtml ? '<br><small style="color:#aaa">Recent Refs:</small>' + refHtml : ''}<br>
                        ğŸ« <b>Ticket:</b> ${u.supportTicket ? '<span style="color:var(--warning)">OPEN</span>' : 'None'}<br>
                        ğŸŒ <b>IP:</b> ${u.lastIP || 'Unknown'}
                    </div>
                    <div style="margin-top:15px; border-top:1px solid #333; pt-2">
                        <small style="color:#aaa">Recent Logs:</small>
                        ${logsHtml}
                    </div>
                    <div style="display:flex; gap:10px; margin-top:15px;">
                        <button class="btn-ban" onclick="toggleBan(true)" ${banDisabled ? 'disabled' : ''}>ğŸš« Ban</button>
                        <button class="btn-unban" onclick="toggleBan(false)" ${unbanDisabled ? 'disabled' : ''}>ğŸ”“ Unban</button>
                    </div>
                `;
                toast("Data Loaded");
            } else {
                box.style.display = "none";
                toast("User Not Found", "error");
            }
        }

        async function updateStatus(st) {
            const id = document.getElementById('targetId').value;
            const ref = document.getElementById('txRef').value;
            if(!id || !ref) return toast("Missing Data", "error");
            if(!confirm(st === 'approved' ? "Confirm APPROVE?" : "Confirm REJECT?")) return;
            
            saveUserId(id);
            const d = await api("admin_update_status", { targetUserId: id, txRef: ref, status: st });
            if(d.ok) { 
                toast(st === 'approved' ? "Approved âœ…" : "Rejected âŒ"); 
                document.getElementById('txRef').value = '';
                if(document.getElementById('searchId').value == id) fetchUserInfo(); 
            } else { toast(d.error, "error"); }
        }

        async function toggleBan(state) {
            const id = document.getElementById('searchId').value;
            if(!id) return toast("Search User First", "error");
            if(!confirm(`Confirm ${state ? "BAN" : "UNBAN"}?`)) return;
            const d = await api("admin_toggle_ban", { targetUserId: id, isBanned: state });
            if(d.ok) { toast("Success"); fetchUserInfo(); } else { toast(d.error, "error"); }
        }

        async function manualUpdate() {
            const id = document.getElementById('manualId').value;
            const bal = document.getElementById('manualBalance').value;
            const vip = document.getElementById('manualVip').value;
            if(!id) return toast("Target ID Required", "error");
            
            let payload = { targetUserId: id };
            if(bal) payload.manualBalance = parseFloat(bal);
            if(vip) payload.manualVip = parseInt(vip);
            
            if(!confirm("âš ï¸ Confirm Manual Edit?")) return;
            const d = await api("admin_manual_edit", payload);
            if(d.ok) { toast("Saved âœ…"); document.getElementById('manualBalance').value=''; } else { toast(d.error, "error"); }
        }
    </script>
</body>
</html>
