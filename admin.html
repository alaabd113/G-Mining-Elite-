<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TokenDrip Admin</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg-color: #0f0f0f; --card-bg: #1c1c1c; --primary: #00E676; --danger: #f44336; --warning: #FFC107; --text-color: #ffffff; --input-bg: #252525; --border: #333; }
        body { background-color: var(--bg-color); color: var(--text-color); font-family: 'Cairo', sans-serif; margin: 0; padding: 20px; padding-bottom: 80px; }
        .header { text-align: center; margin-bottom: 30px; }
        .card { background: var(--card-bg); border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid var(--border); box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        h3 { margin-top: 0; color: var(--primary); font-size: 1.1rem; border-bottom: 1px solid var(--border); padding-bottom: 10px;}
        label { display: block; margin-bottom: 5px; color: #aaa; font-size: 0.9rem; margin-top: 10px;}
        .input-group { display: flex; gap: 5px; }
        .input-group input { border-radius: 8px 0 0 8px; margin-bottom: 5px; }
        .input-group button { width: 50px; flex: none; border-radius: 0 8px 8px 0; margin-bottom: 5px; padding: 0; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; background: #333; color: white; }
        input, select { width: 100%; padding: 12px; background: var(--input-bg); border: 1px solid #444; border-radius: 8px; color: white; font-family: inherit; font-size: 1rem; margin-bottom: 5px; box-sizing: border-box; }
        .btn-group { display: flex; gap: 15px; margin-top: 15px;}
        button { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-family: inherit; transition: 0.2s; font-size: 1rem; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-approve { background: var(--primary); color: #000; box-shadow: 0 0 15px rgba(0,230,118,0.2); border: 1px solid var(--primary); }
        .btn-reject { background: rgba(244,67,54,0.1); color: var(--danger); border: 1px solid var(--danger); box-shadow: 0 0 10px rgba(244,67,54,0.1); }
        .btn-blue { background: #2196F3; color: white; width: 100%; margin-top: 15px;}
        .btn-ban { background: #660000; color: white; border: 1px solid #ff0000; margin-top: 10px; }
        .btn-unban { background: #333; color: white; border: 1px solid #555; margin-top: 10px; }
        .btn-search { background: #FF9800; color: black; margin-top: 10px; width: 100%; }
        #loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 50px; height: 50px; border: 5px solid #333; border-top: 5px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; mb-3; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #toast { visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333; color: #fff; text-align: center; border-radius: 50px; padding: 16px; position: fixed; z-index: 10000; left: 50%; bottom: 30px; font-size: 1rem; box-shadow: 0 4px 15px rgba(0,0,0,0.5); opacity: 0; transition: 0.5s; }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }
        #toast.success { background-color: var(--primary); color: black; }
        #toast.error { background-color: var(--danger); }
        #searchResult { margin-top: 10px; padding: 10px; background: #2a2a2a; border-radius: 6px; border: 1px dashed #555; display: none; }
        .log-entry { font-size: 0.8rem; border-bottom: 1px solid #444; padding: 5px 0; display: flex; justify-content: space-between; }
    </style>
</head>
<body>
    <div id="loader-overlay"><div class="spinner"></div><p style="margin-top: 15px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</p></div>
    <div id="toast">ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©!</div>
    <div class="header"><h1>ğŸ›¡ï¸ Admin Panel</h1></div>
    
    <div id="loginSection" style="display:none; text-align:center; padding:50px 0;">
        <h2 style="color:var(--danger)">ğŸ”’ Access Locked</h2>
        <p style="color:#aaa; margin-bottom:20px;">Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø±Ù ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.<br>Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©.</p>
        <input type="password" id="adminPass" placeholder="Password" style="text-align:center; font-size:1.2rem; margin-bottom:15px;">
        <button class="btn-blue" onclick="checkPass()">Login</button>
        <p id="debugId" style="margin-top:20px; font-size:0.8rem; color:#555;"></p>
    </div>

    <div id="adminContent" style="display:none;">
        <div class="card">
            <h3>ğŸ” ÙØ­Øµ Ù…Ø³ØªØ®Ø¯Ù… (Check User)</h3>
            <input type="number" id="searchId" class="user-id-input" placeholder="User ID">
            <button class="btn-search" onclick="fetchUserInfo()">Ø¨Ø­Ø« ÙˆØ§Ø³ØªØ¹Ù„Ø§Ù…</button>
            <div id="searchResult"></div>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn-ban" onclick="toggleBan(true)">ğŸš« Ø­Ø¸Ø± (Ban)</button>
                <button class="btn-unban" onclick="toggleBan(false)">ğŸ”“ ÙÙƒ Ø§Ù„Ø­Ø¸Ø±</button>
            </div>
        </div>

        <div class="card">
            <h3>âš¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª (Process TX)</h3>
            <label>User ID</label>
            <input type="number" id="targetId" class="user-id-input" placeholder="User ID">
            <label>TX Reference</label>
            <div class="input-group">
                <input type="text" id="txRef" placeholder="dep_... | wd_...">
                <button onclick="pasteToTxRef()">ğŸ“‹</button>
            </div>
            <div class="btn-group">
                <button class="btn-approve" onclick="updateStatus('approved')">âœ… Ù…ÙˆØ§ÙÙ‚Ø©</button>
                <button class="btn-reject" onclick="updateStatus('rejected')">âŒ Ø±ÙØ¶</button>
            </div>
        </div>

        <div class="card">
            <h3>ğŸ› ï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±ØµÙŠØ¯/VIP</h3>
            <label>Target ID</label>
            <input type="number" id="manualId" class="user-id-input" placeholder="User ID">
            <label>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±ØµÙŠØ¯</label>
            <input type="number" id="manualBalance" placeholder="+ / -">
            <label>ØªØºÙŠÙŠØ± Ù…Ø³ØªÙˆÙ‰ VIP</label>
            <select id="manualVip">
                <option value="">-- Ù„Ø§ ØªØºÙŠÙŠØ± --</option>
                <option value="0">VIP 0</option>
                <option value="1">VIP 1</option>
                <option value="2">VIP 2</option>
                <option value="3">VIP 3</option>
                <option value="4">VIP 4</option>
                <option value="5">VIP 5</option>
                <option value="6">VIP 6</option>
            </select>
            <button class="btn-blue" onclick="manualUpdate()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
        </div>
    </div>

    <script>
        // âš ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³ÙŠØ±ÙØ±
        const SERVER = "https://steep-resonance-6443.alaabdalaziz01.workers.dev";
        const ALLOWED_ADMIN_ID = 921301895;
        const ADMIN_PASS = "123456"; // ğŸ” ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ (ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ±Ù‡Ø§)

        const tg = window.Telegram.WebApp;
        tg.expand();

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯Ø®ÙˆÙ„ ---
        window.onload = function() {
            const userId = tg.initDataUnsafe?.user?.id;
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ø¢ÙŠØ¯ÙŠ Ø§Ù„Ø°ÙŠ ÙŠØ±Ø§Ù‡ Ø§Ù„Ù†Ø¸Ø§Ù… (Ù„Ø£ØºØ±Ø§Ø¶ Ø§Ù„ØªØµØ­ÙŠØ­)
            document.getElementById('debugId').innerText = `Detected ID: ${userId || 'Hidden/Unknown'}`;

            if (userId === ALLOWED_ADMIN_ID) {
                // Ø¥Ø°Ø§ ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¢ÙŠØ¯ÙŠØŒ Ø§Ø¯Ø®Ù„ ÙÙˆØ±Ø§Ù‹
                showAdminPanel();
            } else {
                // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªØ·Ø§Ø¨Ù‚ Ø£Ùˆ ÙƒØ§Ù† Ù…Ø®ÙÙŠØ§Ù‹ØŒ Ø§Ø·Ù„Ø¨ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
                document.getElementById('loginSection').style.display = 'block';
            }

            const lastId = localStorage.getItem('lastAdminUserId'); 
            if(lastId) document.querySelectorAll('.user-id-input').forEach(input => input.value = lastId); 
        };

        function checkPass() {
            const input = document.getElementById('adminPass').value;
            if (input === ADMIN_PASS) {
                showAdminPanel();
            } else {
                alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©!");
            }
        }

        function showAdminPanel() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('adminContent').style.display = 'block';
        }

        // --- Ø¨Ø§Ù‚ÙŠ ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø¯Ù…Ù† (ÙƒÙ…Ø§ Ù‡ÙŠ) ---
        function saveUserId(id) { if(id) { localStorage.setItem('lastAdminUserId', id); document.querySelectorAll('.user-id-input').forEach(input => input.value = id); } }
        function setBusyState(isBusy) { document.getElementById('loader-overlay').style.display = isBusy ? 'flex' : 'none'; }
        function showToast(message, type = 'success') { const toast = document.getElementById("toast"); toast.className = "show " + type; toast.innerText = message; setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000); }
        async function pasteToTxRef() { try { const text = await navigator.clipboard.readText(); document.getElementById('txRef').value = text; showToast("ØªÙ… Ø§Ù„Ù„ØµÙ‚", "success"); } catch (err) { showToast("ØªØ¹Ø°Ø± Ø§Ù„Ù„ØµÙ‚", "error"); } }

        async function api(action, payload) {
            setBusyState(true);
            // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù†Ø±Ø³Ù„ Ø§Ù„Ø¢ÙŠØ¯ÙŠ Ø§Ù„Ø«Ø§Ø¨Øª Ù„Ù„Ø£Ø¯Ù…Ù† Ø­ØªÙ‰ Ù„Ùˆ Ø¯Ø®Ù„Øª Ø¨ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù„ØªØ¬Ø§ÙˆØ² ÙØ­Øµ Ø§Ù„Ø³ÙŠØ±ÙØ±
            // Ù„ÙƒÙ† Ø¨Ù…Ø§ Ø£Ù†Ùƒ ØªÙ…Ù„Ùƒ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…ØŒ ÙØ£Ù†Øª Ø§Ù„Ø£Ø¯Ù…Ù†
            try {
                const res = await fetch(SERVER, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ initData: tg.initData, action, payload }) });
                setBusyState(false);
                return await res.json();
            } catch (e) {
                setBusyState(false);
                showToast("Error: " + e.message, "error");
                return { ok: false };
            }
        }

        async function fetchUserInfo() {
            const id = document.getElementById('searchId').value;
            if(!id) return showToast("Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¹Ø±Ù", "error");
            saveUserId(id);
            const data = await api("admin_get_user", { targetUserId: id });
            const resultBox = document.getElementById('searchResult');

            if(data.ok && data.user) {
                let logsHtml = '';
                if(data.user.logs && data.user.logs.length > 0) {
                    logsHtml = `<div style="margin-top:10px; border-top:1px solid #444; padding-top:5px;"><small style="color:#aaa">Ø¢Ø®Ø± Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª:</small>`;
                    data.user.logs.slice(0, 5).forEach(l => { logsHtml += `<div class="log-entry"><span>${l.type}</span><span style="color:${l.amount>0?'#00E676':'#FF5252'}">${l.amount}$</span></div>`; });
                    logsHtml += `</div>`;
                }
                resultBox.style.display = "block";
                resultBox.innerHTML = `<div style="font-size:0.9rem; line-height:1.6;">ğŸ‘¤ <b>Ø§Ù„Ø§Ø³Ù…:</b> ${data.user.username || 'Unknown'}<br>ğŸ’° <b>Ø§Ù„Ø±ØµÙŠØ¯:</b> <span style="color:#00E676">${data.user.balance}$</span><br>ğŸ’ <b>VIP:</b> Level ${data.user.vip}<br>ğŸ‘¥ <b>Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª:</b> ${data.user.referrals}<br>ğŸš« <b>Ù…Ø­Ø¸ÙˆØ±:</b> <span style="color:${data.user.isBanned ? 'red' : 'green'}">${data.user.isBanned ? 'Ù†Ø¹Ù… (BANNED)' : 'Ù„Ø§'}</span>${logsHtml}</div>`;
                showToast("ØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", "success");
            } else {
                resultBox.style.display = "none";
                showToast("Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯", "error");
            }
        }

        async function toggleBan(isBanned) {
            const id = document.getElementById('searchId').value;
            if(!id) return showToast("Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¹Ø±Ù ÙÙŠ Ø®Ø§Ù†Ø© Ø§Ù„Ø¨Ø­Ø« Ø£ÙˆÙ„Ø§Ù‹", "error");
            if (!confirm(`âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ${isBanned ? "Ø­Ø¸Ø±" : "ÙÙƒ Ø­Ø¸Ø±"} Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${id}ØŸ`)) return;
            const data = await api("admin_toggle_ban", { targetUserId: id, isBanned });
            if(data.ok) { showToast(isBanned ? "ØªÙ… Ø§Ù„Ø­Ø¸Ø± ğŸš«" : "ØªÙ… ÙÙƒ Ø§Ù„Ø­Ø¸Ø± ğŸ”“", "success"); fetchUserInfo(); }
            else showToast("ÙØ´Ù„: " + data.error, "error");
        }

        async function updateStatus(status) {
            const targetId = document.getElementById('targetId').value.trim();
            const txRef = document.getElementById('txRef').value.trim();
            if (!targetId || !txRef) return showToast("Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©", "error");
            if (!confirm(status === 'approved' ? "âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©ØŸ" : "âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø±ÙØ¶ØŸ")) return;
            saveUserId(targetId);
            const data = await api("admin_update_status", { targetUserId: targetId, txRef, status });
            if (data.ok) { showToast(status === 'approved' ? "ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© âœ…" : "ØªÙ… Ø§Ù„Ø±ÙØ¶ âŒ", status === 'approved' ? 'success' : 'error'); document.getElementById('txRef').value = ''; }
            else { showToast("ÙØ´Ù„: " + data.error, "error"); }
        }

        async function manualUpdate() {
            const targetId = document.getElementById('manualId').value.trim();
            const balanceInput = document.getElementById('manualBalance').value;
            const vipInput = document.getElementById('manualVip').value;
            if (!targetId) return showToast("Ø­Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…", "error");
            let payload = { targetUserId: targetId };
            if (balanceInput !== "") payload.manualBalance = parseFloat(balanceInput);
            if (vipInput !== "") payload.manualVip = parseInt(vipInput);
            if (Object.keys(payload).length === 1) return showToast("Ù„Ù… ØªÙ‚Ù… Ø¨Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„", "warning");
            if (!confirm(`âš ï¸ ØªØ­Ø°ÙŠØ± Ø£Ù…Ù†ÙŠ:\nÙ‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª ${targetId} ÙŠØ¯ÙˆÙŠØ§Ù‹ØŸ`)) return;
            saveUserId(targetId);
            const data = await api("admin_manual_edit", payload);
            if (data.ok) { showToast("ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…", "success"); document.getElementById('manualBalance').value = ''; document.getElementById('manualVip').value = ''; }
            else { showToast("Ø®Ø·Ø£: " + data.error, "error"); }
        }
    </script>
</body>
</html>
