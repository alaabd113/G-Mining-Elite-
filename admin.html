<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TokenDrip Admin Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0f0f0f;
            --card-bg: #1c1c1c;
            --primary: #00E676;
            --danger: #f44336;
            --warning: #FFC107;
            --text-color: #ffffff;
            --input-bg: #252525;
            --border: #333;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Cairo', sans-serif;
            margin: 0;
            padding: 20px;
            padding-bottom: 80px; /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ø¥Ø´Ø¹Ø§Ø± */
        }

        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { margin: 0; font-size: 1.5rem; }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        h3 { margin-top: 0; color: var(--primary); font-size: 1.1rem; border-bottom: 1px solid var(--border); padding-bottom: 10px;}
        
        label { display: block; margin-bottom: 5px; color: #aaa; font-size: 0.9rem; margin-top: 10px;}
        
        /* Input Group Ù„ØªØ­Ø³ÙŠÙ† Ø²Ø± Ø§Ù„Ù†Ø³Ø® */
        .input-group { display: flex; gap: 5px; }
        .input-group input { border-radius: 8px 0 0 8px; margin-bottom: 5px; }
        .input-group button { 
            width: 50px; flex: none; border-radius: 0 8px 8px 0; 
            margin-bottom: 5px; padding: 0; display: flex; 
            align-items: center; justify-content: center; font-size: 1.2rem;
            background: #333; color: white;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            background: var(--input-bg);
            border: 1px solid #444;
            border-radius: 8px;
            color: white;
            font-family: inherit;
            font-size: 1rem;
            margin-bottom: 5px;
            box-sizing: border-box;
            transition: 0.3s;
        }

        input:focus { border-color: var(--primary); outline: none; }

        .btn-group { display: flex; gap: 10px; margin-top: 15px;}

        button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-family: inherit;
            transition: 0.2s;
            font-size: 1rem;
        }

        /* ØªØ£Ø«ÙŠØ± Ø§Ù„ØªØ¹Ø·ÙŠÙ„ */
        button:disabled, input:disabled, select:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(100%);
        }

        .btn-approve { background: var(--primary); color: #000; }
        .btn-reject { background: var(--danger); color: white; }
        .btn-blue { background: #2196F3; color: white; width: 100%; margin-top: 15px;}
        .btn-search { background: #FF9800; color: black; margin-top: 10px; width: 100%; }

        .note {
            font-size: 0.8rem; color: #888; background: rgba(255,255,255,0.05);
            padding: 10px; border-radius: 6px; margin-bottom: 15px; line-height: 1.4;
        }

        .checkbox-container {
            display: flex; align-items: center; margin-top: 15px; font-size: 0.9rem;
            background: rgba(33, 150, 243, 0.1); padding: 10px; border-radius: 6px;
        }
        .checkbox-container input { width: auto; margin: 0 0 0 10px; cursor: pointer; }

        /* Loader Overlay */
        #loader-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 9999;
            display: none; flex-direction: column;
            align-items: center; justify-content: center;
        }
        .spinner {
            width: 50px; height: 50px; border: 5px solid #333;
            border-top: 5px solid var(--primary); border-radius: 50%;
            animation: spin 1s linear infinite; mb-3;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Toast Notification (Ø±Ø³Ø§Ø¦Ù„ Ù…Ù„ÙˆÙ†Ø©) */
        #toast {
            visibility: hidden;
            min-width: 250px;
            margin-left: -125px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 50px;
            padding: 16px;
            position: fixed;
            z-index: 10000;
            left: 50%;
            bottom: 30px;
            font-size: 1rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            opacity: 0;
            transition: opacity 0.5s, bottom 0.5s;
        }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }
        #toast.success { background-color: var(--primary); color: black; }
        #toast.error { background-color: var(--danger); }
        #toast.warning { background-color: var(--warning); color: black; }
        
        #searchResult {
            margin-top: 10px; padding: 10px; background: #2a2a2a; 
            border-radius: 6px; border: 1px dashed #555; display: none;
        }
    </style>
</head>
<body>
    <div id="loader-overlay">
        <div class="spinner"></div>
        <p style="margin-top: 15px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</p>
    </div>

    <div id="toast">ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©!</div>

    <div class="header">
        <h1>ğŸ›¡ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Pro</h1>
        <p style="color: #666;">Ø¥ØµØ¯Ø§Ø± Ù…ØªÙ‚Ø¯Ù… Ù…Ø¹ ØªØ­Ø³ÙŠÙ†Ø§Øª UX</p>
    </div>

    <div class="card">
        <h3>ğŸ” Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù…</h3>
        <input type="number" id="searchId" class="user-id-input" placeholder="User ID">
        <button class="btn-search" onclick="fetchUserInfo()">Ø¨Ø­Ø«</button>
        <div id="searchResult"></div>
    </div>

    <div class="card">
        <h3>âš¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3>
        <div class="note">
            ØªÙ… ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù†Ø³Ø®: Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø­Ù‚Ù„ Ù„Ù†Ø³Ø® Ø£Ùˆ Ù„ØµÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.
        </div>

        <label>Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (User ID)</label>
        <input type="number" id="targetId" class="user-id-input" placeholder="User ID">

        <label>Ù…ÙØªØ§Ø­ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© (TX_REF)</label>
        <div class="input-group">
            <input type="text" id="txRef" placeholder="dep_123... | wd_456...">
            <button onclick="pasteToTxRef()" title="Ù„ØµÙ‚ Ù…Ù† Ø§Ù„Ø­Ø§ÙØ¸Ø©">ğŸ“‹</button>
        </div>

        <div class="btn-group">
            <button class="btn-approve" onclick="updateStatus('approved')">âœ… Ù…ÙˆØ§ÙÙ‚Ø©</button>
            <button class="btn-reject" onclick="updateStatus('rejected')">âŒ Ø±ÙØ¶</button>
        </div>
    </div>

    <div class="card">
        <h3>ğŸ› ï¸ ØªØ¹Ø¯ÙŠÙ„ ÙŠØ¯ÙˆÙŠ Ù…Ø¨Ø§Ø´Ø±</h3>
        
        <label>Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Target ID)</label>
        <input type="number" id="manualId" class="user-id-input" placeholder="User ID">

        <label>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±ØµÙŠØ¯ (+ Ø¥Ø¶Ø§ÙØ© / - Ø®ØµÙ…)</label>
        <input type="number" id="manualBalance" placeholder="Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ù„Ù„ØªØ¬Ø§Ù‡Ù„">

        <label>ØªØºÙŠÙŠØ± Ù…Ø³ØªÙˆÙ‰ VIP</label>
        <select id="manualVip">
            <option value="">-- Ù„Ø§ ØªØºÙŠÙŠØ± --</option>
            <option value="0">VIP 0 (Free)</option>
            <option value="1">VIP 1 (Bronze)</option>
            <option value="2">VIP 2 (Silver)</option>
            <option value="3">VIP 3 (Gold)</option>
        </select>

        <div class="checkbox-container">
            <input type="checkbox" id="confirmCheck">
            <label for="confirmCheck" style="margin:0; color:white; cursor:pointer;">Ø£Ù†Ø§ Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</label>
        </div>

        <button class="btn-blue" onclick="manualUpdate()">ğŸ’¾ ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
    </div>

    <script>
        const SERVER = "https://steep-resonance-6443.alaabdalaziz01.workers.dev";
        const tg = window.Telegram.WebApp;
        tg.expand();

        // --- Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù… (System Tools) ---

        // 1. ØªØ­Ù…ÙŠÙ„ Ø¢Ø®Ø± User ID Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­
        window.onload = function() {
            const lastId = localStorage.getItem('lastAdminUserId');
            if(lastId) {
                // ØªØ¹Ø¨Ø¦Ø© ÙƒÙ„ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù€ ID ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                document.querySelectorAll('.user-id-input').forEach(input => {
                    input.value = lastId;
                });
            }
        };

        // Ø­ÙØ¸ Ø§Ù„Ù€ ID Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹
        function saveUserId(id) {
            if(id) {
                localStorage.setItem('lastAdminUserId', id);
                // ØªØ­Ø¯ÙŠØ« Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙÙŠ Ø§Ù„ØµÙØ­Ø© ÙÙˆØ±Ø§Ù‹
                document.querySelectorAll('.user-id-input').forEach(input => {
                    input.value = id;
                });
            }
        }

        // 2. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆØ§Ù„Ù„ÙˆØ¯Ø±
        function setBusyState(isBusy) {
            const loader = document.getElementById('loader-overlay');
            const buttons = document.querySelectorAll('button');
            const inputs = document.querySelectorAll('input, select');

            loader.style.display = isBusy ? 'flex' : 'none';

            buttons.forEach(btn => btn.disabled = isBusy);
            inputs.forEach(inp => inp.disabled = isBusy);
        }

        // 3. Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù„ÙˆÙ† (Toast)
        function showToast(message, type = 'success') {
            const toast = document.getElementById("toast");
            toast.className = "show " + type; // success, error, warning
            toast.innerText = message;
            
            // Ø¥Ø®ÙØ§Ø¡ Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†ÙŠ
            setTimeout(function(){ 
                toast.className = toast.className.replace("show", ""); 
            }, 3000);
        }

        // 4. Ù„ØµÙ‚ Ø³Ø±ÙŠØ¹ Ù„Ù€ TX_REF
        async function pasteToTxRef() {
            try {
                const text = await navigator.clipboard.readText();
                document.getElementById('txRef').value = text;
                showToast("ØªÙ… Ø§Ù„Ù„ØµÙ‚ Ù…Ù† Ø§Ù„Ø­Ø§ÙØ¸Ø©", "warning");
            } catch (err) {
                showToast("Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø­Ø§ÙØ¸Ø© Ù…Ø±ÙÙˆØ¶", "error");
            }
        }

        // --- Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ± ---
        async function api(action, payload) {
            setBusyState(true);
            try {
                const res = await fetch(SERVER, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        initData: tg.initData,
                        action: action,
                        payload: payload
                    })
                });
                const data = await res.json();
                setBusyState(false);
                return data;
            } catch (e) {
                setBusyState(false);
                showToast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: " + e.message, "error");
                return { ok: false };
            }
        }

        // --- Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ---

        // 1. Ø¨Ø­Ø«
        async function fetchUserInfo() {
            const id = document.getElementById('searchId').value;
            if(!id) return showToast("Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¹Ø±Ù Ø£ÙˆÙ„Ø§Ù‹", "error");
            
            saveUserId(id); // Ø­ÙØ¸ Ø§Ù„Ù€ ID

            const data = await api("admin_get_user", { targetUserId: id });
            const resultBox = document.getElementById('searchResult');

            if(data.ok && data.user) {
                resultBox.style.display = "block";
                resultBox.innerHTML = `
                    <div style="font-size:0.9rem; line-height:1.6;">
                        ğŸ‘¤ <b>Ø§Ù„Ø§Ø³Ù…:</b> ${data.user.firstName || 'Unknown'}<br>
                        ğŸ’° <b>Ø§Ù„Ø±ØµÙŠØ¯:</b> <span style="color:#00E676">${data.user.balance} USDT</span><br>
                        ğŸ’ <b>Ø§Ù„Ø±ØªØ¨Ø©:</b> VIP ${data.user.vipLevel}
                    </div>
                `;
                showToast("ØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", "success");
            } else {
                resultBox.style.display = "none";
                showToast("Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯", "error");
            }
        }

        // 2. Ù…ÙˆØ§ÙÙ‚Ø© / Ø±ÙØ¶
        async function updateStatus(status) {
            const targetId = document.getElementById('targetId').value.trim();
            const txRef = document.getElementById('txRef').value.trim();

            if (!targetId || !txRef) return showToast("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©!", "error");
            if (!txRef.includes('_')) return showToast("TX_REF ØºÙŠØ± ØµØ§Ù„Ø­", "error");

            saveUserId(targetId);

            tg.showConfirm(`ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŸ`, async (confirmed) => {
                if (!confirmed) return;
                
                const data = await api("admin_update_status", { targetUserId: targetId, txRef, status });
                
                if (data.ok) {
                    showToast("âœ… ØªÙ… ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­", "success");
                    document.getElementById('txRef').value = ''; // Ù…Ø³Ø­ Ø§Ù„Ù…ÙØªØ§Ø­ ÙÙ‚Ø·
                } else {
                    showToast("âŒ ÙØ´Ù„: " + (data.error || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"), "error");
                }
            });
        }

        // 3. ØªØ¹Ø¯ÙŠÙ„ ÙŠØ¯ÙˆÙŠ Ø°ÙƒÙŠ
        async function manualUpdate() {
            const targetId = document.getElementById('manualId').value.trim();
            const balanceInput = document.getElementById('manualBalance').value;
            const vipInput = document.getElementById('manualVip').value;
            const isConfirmed = document.getElementById('confirmCheck').checked;

            if (!targetId) return showToast("Ù…Ø·Ù„ÙˆØ¨ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…", "error");
            if (!isConfirmed) return showToast("ÙŠØ¬Ø¨ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹", "warning");

            saveUserId(targetId);

            // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø§ÙŠÙ„ÙˆØ¯ Ø§Ù„Ø°ÙƒÙŠ
            let payload = { targetUserId: targetId };
            if (balanceInput !== "") payload.manualBalance = parseFloat(balanceInput);
            if (vipInput !== "") payload.manualVip = parseInt(vipInput);

            if (Object.keys(payload).length === 1) {
                return showToast("Ù„Ù… ÙŠØªÙ… Ø¥Ø¯Ø®Ø§Ù„ ØªØºÙŠÙŠØ±Ø§Øª!", "warning");
            }

            const data = await api("admin_manual_edit", payload);

            if (data.ok) {
                showToast("âœ… ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", "success");
                document.getElementById('manualBalance').value = '';
                document.getElementById('manualVip').value = '';
                document.getElementById('confirmCheck').checked = false;
            } else {
                showToast("â›” Ø®Ø·Ø£: " + (data.error || "Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª"), "error");
            }
        }
    </script>
</body>
</html>
